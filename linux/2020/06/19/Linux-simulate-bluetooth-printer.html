<!DOCTYPE html> <html lang=zh-CN> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Linux 模拟蓝牙打印机 - C4IO</title> <meta name="description" data-hid="description" data-n-head="true" content="Linux 模拟蓝牙打印机."> <meta name="author" content="Player"> <meta name="copyright" content="CC BY-NC 4.0"> <link rel="stylesheet" href="/css/app.css"> <link rel="stylesheet" href="/css/asciidoctor.css"> </head> <body> <!-- Nav Bar --> <nav class="navbar navbar-expand-md fixed-top navbar-dark bg-dark"> <h1 class="siteTitle"><a class="navbar-brand" href="/">C4IO</a></h1> <div class="collapse navbar-collapse" id="navbarData" > <ul class="navbar-nav mr-auto"> <li class="nav-item"> <a class="nav-link " href="/">主页</a> </li> <li class="nav-item"> <a class="nav-link " href="/projects/">项目</a> </li> <li class="nav-item"> <a class="nav-link " href="/posts/">文章</a> </li> <li class="nav-item"> <a class="nav-link " href="/categories/">分类</a> </li> <li class="nav-item"> <a class="nav-link " href="/tags/">标签</a> </li> </ul> </div> </nav> <!-- End Nav --> <!-- Main Page Content and Sidebar --> <div class="container-fluid"> <div class="row flex-xl-nowrap"> <div class="col-md-2 col-xl-2"> <h1>Linux 模拟蓝牙打印机 </h1> </div> <div id="docInfo" class="col-md-2 col-xl-2"> <div class="card mb-2" > <div class="card-header">作者</div> <ul class="list-group list-group-flush"> <li class="list-group-item">player</li> <li class="list-group-item">2020-06-19 00:00:00 +0800</li> </ul> </div> <div class="card mb-2" > <div class="card-header">版权</div> <ul class="list-group list-group-flush"> <li class="list-group-item"><a href="http://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></li> </ul> </div> <div class="card mb-2" > <div class="card-header">分类</div> <ul class="list-group list-group-flush"> <li class="badge badge-pill badge-primary" >Linux</li> </ul> </div> <div class="card mb-2" > <div class="card-header">标签</div> <ul class="list-group list-group-flush"> <li class="badge badge-pill badge-secondary" >蓝牙</li> <li class="badge badge-pill badge-secondary" >打印机</li> <li class="badge badge-pill badge-secondary" >模拟</li> <li class="badge badge-pill badge-secondary" >Linux</li> </ul> </div> </div> <div class="col-md-2 col-xl-2 bd-sidebar"> <div id="toc" class="card"> <div id="toctitle" class="card-header"> 目录 </div> <div class="card-body"> <ul class="sectlevel1"> <li><a href="#引言">1. 引言</a></li> <li><a href="#安装bluez">2. 安装Bluez</a></li> <li><a href="#修改蓝牙服务文件">3. 修改蓝牙服务文件</a> <ul class="sectlevel2"> <li><a href="#编辑系统中蓝牙服务文件">3.1. 编辑系统中蓝牙服务文件:</a></li> <li><a href="#重启蓝牙服务">3.2. 重启蓝牙服务</a></li> </ul> </li> <li><a href="#修改蓝牙基本属性">4. 修改蓝牙基本属性</a></li> <li><a href="#设置蓝牙提供的服务">5. 设置蓝牙提供的服务</a></li> <li><a href="#设置_advertise">6. 设置 advertise</a></li> <li><a href="#启动rfcomm">7. 启动rfcomm</a></li> <li><a href="#读串口消息">8. 读串口消息</a></li> <li><a href="#调试">9. 调试</a></li> <li><a href="#总结">10. 总结</a></li> </ul> </div> </div> </div> <main class="col-md-8 col-xl-8 py-md-3 pl-md-5 bd-content" role="main"> <div class="" role="content"> <div class="sect1"> <h2 id="引言">1. 引言</h2> <div class="sectionbody"> <div class="paragraph"> <p>手机可以连接蓝牙打印机进行打印，但有时候没有蓝牙打印机，需要通过一些设施把 蓝牙信号转换成传统打印机或者分发到其他打印机中.</p> </div> <div class="paragraph"> <p>本文就描述了如何在Linux系统中模拟蓝牙打印机，并获取到蓝牙接收到的数据.</p> </div> <div class="paragraph"> <p>注意,本文中的所有操作都是基于Ubuntu发行版.</p> </div> <div class="paragraph"> <p>手机链接蓝牙打印的主要原理是基于串口通讯进行打印，这个串口通讯又基于蓝牙 进行传输。</p> </div> </div> </div> <div class="sect1"> <h2 id="安装bluez">2. 安装Bluez</h2> <div class="sectionbody"> <div class="paragraph"> <p>Linux 中蓝牙的维护和管理是通过Bluez组件进行管理，需要安装，命令如下:</p> </div> <div class="literalblock"> <div class="content"><pre>$sudo apt-get -y install bluetooth bluez bluez-tools rfkill</pre></div> </div> </div> </div> <div class="sect1"> <h2 id="修改蓝牙服务文件">3. 修改蓝牙服务文件</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="编辑系统中蓝牙服务文件">3.1. 编辑系统中蓝牙服务文件:</h3> <div class="paragraph"> <p>蓝牙服务配置文件路径如下:</p> </div> <div class="literalblock"> <div class="content"><pre>#vi /etc/systemd/system/dbus-org.bluez.service</pre></div> </div> <div class="paragraph"> <p>在文件中做如下修改:</p> </div> <div class="ulist"> <ul> <li> <p>提高蓝牙兼容性,为SDPtool 命令提供支持,在文件中添加</p> <div class="literalblock"> <div class="content"><pre>ExecStart =/usr/lib/Bluetooth/bluetoothd -C</pre></div> </div> </li> <li> <p>启动时添加串口支持,在文件中添加(这个指令可以根据应用情况进行修改):</p> <div class="literalblock"> <div class="content"><pre>ExecStartPost=/usr/bin/sdptool add SP</pre></div> </div> </li> </ul> </div> </div> <div class="sect2"> <h3 id="重启蓝牙服务">3.2. 重启蓝牙服务</h3> <div class="paragraph"> <p>重启蓝牙服务的命令如下</p> </div> <div class="literalblock"> <div class="content"><pre>#systemctl bluetooth restart</pre></div> </div> <div class="paragraph"> <p>检查蓝牙设备有没有启动</p> </div> <div class="literalblock"> <div class="content"><pre>#hciconfig</pre></div> </div> <div class="paragraph"> <p>如果没有启动执行如下指令进行启动</p> </div> <div class="literalblock"> <div class="content"><pre>#hciconfig hciXX up</pre></div> </div> <div class="paragraph"> <p>或关闭</p> </div> <div class="literalblock"> <div class="content"><pre>#hciconfig hciXX down</pre></div> </div> <div class="paragraph"> <p>如果启动蓝牙设备时报 rfkill block 错误则执行如下指令：</p> </div> <div class="paragraph"> <p>获取设备序号:</p> </div> <div class="literalblock"> <div class="content"><pre>#rfkill list</pre></div> </div> <div class="paragraph"> <p>解锁设备号：</p> </div> <div class="literalblock"> <div class="content"><pre>#rfkill unblock X</pre></div> </div> </div> </div> </div> <div class="sect1"> <h2 id="修改蓝牙基本属性">4. 修改蓝牙基本属性</h2> <div class="sectionbody"> <div class="paragraph"> <p>修改蓝牙名称</p> </div> <div class="literalblock"> <div class="content"><pre>#hciconfig hciX name BL_NAME</pre></div> </div> <div class="paragraph"> <p>修改蓝牙Class(类型)值:</p> </div> <div class="literalblock"> <div class="content"><pre>#hciconfig hciX class 0x00000</pre></div> </div> <div class="paragraph"> <p>蓝牙Class值可在 <a href="https://www.ampedrftech.com/cod.htm" class="bare">https://www.ampedrftech.com/cod.htm</a> 网站进行计算.</p> </div> </div> </div> <div class="sect1"> <h2 id="设置蓝牙提供的服务">5. 设置蓝牙提供的服务</h2> <div class="sectionbody"> <div class="paragraph"> <p>查询本地蓝牙提供的服务</p> </div> <div class="literalblock"> <div class="content"><pre>#sdptool browse local</pre></div> </div> <div class="paragraph"> <p>添加本地蓝牙服务，具体值看命令行说明(-h)</p> </div> <div class="literalblock"> <div class="content"><pre>#sdptool add XXX</pre></div> </div> <div class="paragraph"> <p>删除本地蓝牙服务，注意这里需要用到十六进制的 <em>Service RecHandle</em> .</p> </div> </div> </div> <div class="sect1"> <h2 id="设置_advertise">6. 设置 advertise</h2> <div class="sectionbody"> <div class="paragraph"> <p>某些设备或应用在添加打印时需要蓝牙设备广播自己的信息才行.</p> </div> <div class="paragraph"> <p>通过以下步骤配置蓝牙广播：</p> </div> <div class="literalblock"> <div class="content"><pre>#bluetoothctl
[bluetooth]#menu advertise
[bluetooth]#name VirtualPrinter
[bluetooth]#tx-power on
[bluetooth]#uuids 0000febe-0000-1000-8000-00805f9b34fb
[bluetooth]#manufacturer 0x0a01
[bluetooth]#discoverable on</pre></div> </div> <div class="paragraph"> <p>上述命令中的 name 可以依据实际需求进行修改, uuids 也可以依据实际需求修改，以上参数是 在测试中检测到的周围设备的参数.</p> </div> </div> </div> <div class="sect1"> <h2 id="启动rfcomm">7. 启动rfcomm</h2> <div class="sectionbody"> <div class="paragraph"> <p>需要通过 <em>rfcomm</em> 程序,将蓝牙SP通讯协议转换成串口设备:</p> </div> <div class="literalblock"> <div class="content"><pre>#rfcomm watch hci0</pre></div> </div> </div> </div> <div class="sect1"> <h2 id="读串口消息">8. 读串口消息</h2> <div class="sectionbody"> <div class="paragraph"> <p>通过 <em>cat</em> 命令读取串口信息:</p> </div> <div class="literalblock"> <div class="content"><pre>#cat /dev/rfcomm0</pre></div> </div> </div> </div> <div class="sect1"> <h2 id="调试">9. 调试</h2> <div class="sectionbody"> <div class="paragraph"> <p>使用手机中可以蓝牙打印的程序搜索蓝牙打印机，并打印就可以在 <em>cat</em> 程序中看到打印出的数据.</p> </div> </div> </div> <div class="sect1"> <h2 id="总结">10. 总结</h2> <div class="sectionbody"> <div class="paragraph"> <p>Bluez 提供了完善的蓝牙协议栈，通过 <em>hciconfig</em> <em>sdptool</em> <em>bluetoothctl</em> 工具可以快速的对蓝牙进行测试.</p> </div> <div class="paragraph"> <p>其中， <em>hciconfig</em> 提供了直接操作 hci设备的基本参数， <em>sdptool</em> 提供了蓝牙应用协议， <em>bluetoothctl</em> 提供了更详细的蓝牙应用配置.</p> </div> </div> </div> </div> </main> </div> </div> <!-- Footer --> <footer class="container-fluid"> :~ </footer> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?df5e31a289ce16746f6cf04a53ea0948"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </body> </html>
